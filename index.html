<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Year-Round Habit & Goal Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#60a5fa;}
*{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
html,body{margin:0;height:100%;background:linear-gradient(180deg,#071022 0%, #071229 100%);color:#e6eef8;}
.wrap{max-width:1400px;margin:18px auto;padding:18px;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;}
h1{margin:0;font-size:20px;}
button{background:var(--accent);border:none;color:#05203a;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:600;}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);margin-bottom:12px;overflow:auto;}
table{border-collapse:collapse;width:100%;table-layout:fixed;}
th,td{border:1px solid rgba(255,255,255,0.05);padding:6px;text-align:center;word-wrap:break-word;}
td.namecol{text-align:left;padding-left:8px;min-width:120px;}
input[type=checkbox]{width:18px;height:18px;}
textarea{width:100%;border-radius:8px;padding:6px;border:1px solid rgba(255,255,255,0.05);background:transparent;color:inherit;}
.flex{display:flex;gap:8px;align-items:center;}
.small{font-size:13px;color:#94a3b8;}
.goal-color{display:inline-block;width:12px;height:12px;margin-right:4px;border-radius:50%;}
.today{background:rgba(96,165,250,0.2);}
.modal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.8);align-items:center;justify-content:center;z-index:1000;padding:12px;}
.modal-content{background:var(--card);padding:16px;border-radius:12px;width:100%;max-width:320px;}
.week-nav{display:flex;justify-content:center;gap:12px;margin-bottom:8px;flex-wrap:wrap;}
.chart-controls{margin-bottom:8px;display:flex;gap:12px;align-items:center;}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--muted);}
label{display:block;margin-bottom:8px;}
label input,label select,label textarea{width:100%;margin-top:4px;padding:6px;border-radius:4px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:inherit;}

/* Mobile responsive styles */
@media (max-width: 768px) {
    .wrap{padding:8px;}
    header{flex-direction:column;gap:12px;align-items:stretch;}
    .flex{flex-wrap:wrap;justify-content:center;}
    button{padding:8px 12px;font-size:14px;}
    .card{padding:8px;}
    table{font-size:12px;}
    th,td{padding:4px;}
    td.namecol{min-width:100px;}
    input[type=checkbox]{width:16px;height:16px;}
    .chart-controls{flex-direction:column;align-items:stretch;}
    #journalArea{grid-template-columns:1fr;}
    .modal-content{max-width:95%;margin:12px;}
}

@media (max-width: 480px) {
    .week-nav{flex-direction:column;align-items:center;}
    button{width:100%;margin:2px 0;}
    table{font-size:11px;}
    th,td{padding:2px;}
}

.sync-status{display:inline-block;margin-left:8px;font-size:12px;}
.sync-success{color:#4ade80;}
.sync-error{color:#f87171;}
.sync-loading{color:#fbbf24;}
</style>
</head>
<body>
<div class="wrap">
<header>
<h1>Habit & Goal Tracker <span id="syncStatus" class="sync-status"></span></h1>
<div class="flex" style="gap:8px;flex-wrap:wrap;">
<button id="prevWeek">‚Üê Prev Week</button>
<button id="thisWeek">This Week</button>
<button id="nextWeek">Next Week ‚Üí</button>
<button id="addHabitBtn">+ Habit</button>
<button id="addGoalBtn">+ Goal</button>
<button id="resetBtn">Reset</button>
<button id="exportBtn">Export</button>
<button id="importBtn">Import</button>
<button id="syncBtn">üîÑ Sync</button>
</div>
</header>

<div class="card week-nav">
<span id="weekLabel"></span>
</div>

<div class="card">
<table id="habitTable">
<thead id="habitHead"></thead>
<tbody id="habitBody"></tbody>
</table>
</div>

<div class="card" style="height:300px;">
<div class="chart-controls">
<label for="chartFilter">Chart View:</label>
<select id="chartFilter">
<option value="week">Current Week</option>
<option value="7">Last 7 Days</option>
<option value="30">Last Month</option>
<option value="365">Last Year</option>
<option value="all">All Time</option>
</select>
</div>
<canvas id="pointsMoodChart"></canvas>
</div>

<div class="card">
<h3>Journal & Mood</h3>
<div id="journalArea" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;"></div>
</div>

<div class="card">
<h3>Goals</h3>
<div id="goalList"></div>
</div>

<!-- Sync Settings Modal -->
<div id="syncModal" class="modal">
<div class="modal-content">
<h3>Cloud Sync Settings</h3>
<div class="small" style="margin-bottom:12px;">Sync your data across all devices using GitHub Gists</div>
<label>GitHub Personal Access Token
<input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
</label>
<label>Gist ID (leave empty to create new)
<input type="text" id="gistId" placeholder="Leave empty for new sync">
</label>
<div class="small">Get token from: GitHub Settings ‚Üí Developer settings ‚Üí Personal access tokens</div>
<div class="flex" style="justify-content:flex-end;margin-top:8px;">
<button id="saveSync">Save & Sync</button>
<button id="cancelSync" class="btn-ghost">Cancel</button>
</div>
</div>
</div>

<!-- Habit Modal -->
<div id="habitModal" class="modal">
<div class="modal-content">
<h3 id="habitModalTitle">Add Habit</h3>
<label>Name<input id="hName" type="text"></label>
<label>Points<input id="hValue" type="number" value="1" min="1"></label>
<label>Notes<textarea id="hNotes" rows="2"></textarea></label>
<label>Goal<select id="hGoal"><option value="">None</option></select></label>
<div class="flex" style="justify-content:flex-end;margin-top:8px;">
<button id="saveHabit">Save</button>
<button id="cancelHabit" class="btn-ghost">Cancel</button>
</div>
</div>
</div>

<!-- Goal Modal -->
<div id="goalModal" class="modal">
<div class="modal-content">
<h3 id="goalModalTitle">Add Goal</h3>
<label>Name<input id="gName" type="text"></label>
<label>Deadline<input id="gDate" type="date"></label>
<label>Color<input id="gColor" type="color" value="#60a5fa"></label>
<div class="flex" style="justify-content:flex-end;margin-top:8px;">
<button id="saveGoal">Save</button>
<button id="cancelGoal" class="btn-ghost">Cancel</button>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
const LS_KEY = 'tracker_v2_data';
const SYNC_KEY = 'tracker_sync_settings';
let state = loadState();
let syncSettings = loadSyncSettings();

// Date helpers
function getMonday(d){d=new Date(d);let day=d.getDay(),diff=d.getDate()-day+ (day===0?-6:1);return new Date(d.setDate(diff));}
function formatDate(d){return d.toISOString().split('T')[0];}
function addDays(d,n){let x=new Date(d);x.setDate(x.getDate()+n);return x;}
function getWeekKey(d){let monday=getMonday(d);return monday.toISOString().split('T')[0];}

// DOM
const habitHead = document.querySelector('#habitHead');
const habitBody = document.querySelector('#habitBody');
const weekLabel = document.querySelector('#weekLabel');
const journalArea = document.querySelector('#journalArea');
const goalList = document.querySelector('#goalList');
const hName=document.querySelector('#hName'),hValue=document.querySelector('#hValue'),hNotes=document.querySelector('#hNotes'),hGoal=document.querySelector('#hGoal');
const gName=document.querySelector('#gName'),gDate=document.querySelector('#gDate'),gColor=document.querySelector('#gColor');
const syncStatus = document.querySelector('#syncStatus');

// Modals
const habitModal=document.querySelector('#habitModal');
const goalModal=document.querySelector('#goalModal');
const syncModal=document.querySelector('#syncModal');
let editHabitId=null,editGoalId=null;

// Chart
const ctx = document.querySelector('#pointsMoodChart').getContext('2d');
let pointsMoodChart = new Chart(ctx,{type:'line',data:{labels:[],datasets:[{label:'Points',data:[],borderColor:'#60a5fa',backgroundColor:'#60a5fa',tension:0.3,fill:false},{label:'Mood',data:[],borderColor:'#facc15',backgroundColor:'#facc15',tension:0.3,fill:false}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}});

// Current week
let currentWeekMonday = getMonday(new Date());

// Utilities
function saveState(){
    localStorage.setItem(LS_KEY,JSON.stringify(state));
    // Auto-sync to cloud if enabled
    if(syncSettings.token) {
        setTimeout(syncToCloud, 100);
    }
}
function loadState(){try{return JSON.parse(localStorage.getItem(LS_KEY))||{habits:[],goals:[],journal:{}}}catch(e){return {habits:[],goals:[],journal:{}};}}
function saveSyncSettings(){localStorage.setItem(SYNC_KEY,JSON.stringify(syncSettings));}
function loadSyncSettings(){try{return JSON.parse(localStorage.getItem(SYNC_KEY))||{token:'',gistId:''}}catch(e){return {token:'',gistId:''};}}
function id(){return 'id_'+Math.random().toString(36).substr(2,9);}

// Cloud Sync Functions
async function syncToCloud() {
    if(!syncSettings.token) return;
    
    setSyncStatus('loading', 'Syncing...');
    
    try {
        const url = syncSettings.gistId 
            ? `https://api.github.com/gists/${syncSettings.gistId}`
            : 'https://api.github.com/gists';
        
        const payload = {
            files: {
                'habit-tracker-data.json': {
                    content: JSON.stringify({
                        state: state,
                        lastSync: new Date().toISOString(),
                        version: '2.0'
                    })
                }
            }
        };
        
        if(syncSettings.gistId) {
            payload.gist_id = syncSettings.gistId;
        }
        
        const response = await fetch(url, {
            method: syncSettings.gistId ? 'PATCH' : 'POST',
            headers: {
                'Authorization': `token ${syncSettings.token}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });
        
        if(!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        
        if(!syncSettings.gistId) {
            syncSettings.gistId = data.id;
            saveSyncSettings();
        }
        
        setSyncStatus('success', 'Synced!');
        setTimeout(() => setSyncStatus('', ''), 3000);
        
    } catch(error) {
        console.error('Sync failed:', error);
        setSyncStatus('error', 'Sync failed');
        setTimeout(() => setSyncStatus('', ''), 5000);
    }
}

async function syncFromCloud() {
    if(!syncSettings.token || !syncSettings.gistId) return;
    
    setSyncStatus('loading', 'Loading...');
    
    try {
        const response = await fetch(`https://api.github.com/gists/${syncSettings.gistId}`, {
            headers: {
                'Authorization': `token ${syncSettings.token}`,
            }
        });
        
        if(!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        const cloudData = JSON.parse(data.files['habit-tracker-data.json'].content);
        
        // Merge cloud data with local data
        state = {
            habits: [...cloudData.state.habits],
            goals: [...cloudData.state.goals],
            journal: {...cloudData.state.journal}
        };
        
        saveState();
        renderWeek();
        setSyncStatus('success', 'Loaded!');
        setTimeout(() => setSyncStatus('', ''), 3000);
        
    } catch(error) {
        console.error('Load failed:', error);
        setSyncStatus('error', 'Load failed');
        setTimeout(() => setSyncStatus('', ''), 5000);
    }
}

function setSyncStatus(type, message) {
    syncStatus.textContent = message;
    syncStatus.className = 'sync-status';
    if(type) syncStatus.classList.add(`sync-${type}`);
}

// Render
function renderWeek(){
    // Week label
    const year=currentWeekMonday.getFullYear();
    const weekNumber = Math.ceil((((currentWeekMonday-new Date(year,0,1))/86400000)+1)/7);
    const endOfWeek = addDays(currentWeekMonday, 6);
    weekLabel.textContent=`Week ${weekNumber} - ${currentWeekMonday.getDate()}/${currentWeekMonday.getMonth()+1} to ${endOfWeek.getDate()}/${endOfWeek.getMonth()+1} ${year}`;
    
    // Table header
    habitHead.innerHTML='';
    let tr = document.createElement('tr');
    tr.innerHTML='<th class="namecol">Habit</th>';
    const today = formatDate(new Date());
    for(let i=0;i<7;i++){
        let d=addDays(currentWeekMonday,i);
        let isToday = formatDate(d) === today;
        tr.innerHTML+=`<th class="${isToday?'today':''}">${d.getDate()}/${d.getMonth()+1}</th>`;
    }
    tr.innerHTML+='<th>Total</th><th>Actions</th>';
    habitHead.appendChild(tr);

    // Table body
    habitBody.innerHTML='';
    state.habits.forEach(h=>{
        let tr=document.createElement('tr');
        tr.innerHTML=`<td class="namecol"><span class="goal-color" style="background-color:${getGoalColor(h.goalId)}"></span><strong>${h.name}</strong><br><span class="small">${h.notes||''}</span></td>`;
        let total=0;
        for(let i=0;i<7;i++){
            let d=addDays(currentWeekMonday,i);
            let checked=h.days?.includes(formatDate(d));
            if(checked) total+=h.value||1;
            let td=document.createElement('td');
            let cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!checked;
            cb.addEventListener('change',()=>{toggleHabitDay(h.id,formatDate(d),cb.checked);});
            td.appendChild(cb);
            tr.appendChild(td);
        }
        let tdTotal=document.createElement('td'); tdTotal.textContent=total; tdTotal.className='habit-row-total'; tr.appendChild(tdTotal);
        
        // Actions column
        let tdActions = document.createElement('td');
        tdActions.innerHTML = `<button data-edit="${h.id}">Edit</button> <button data-delete="${h.id}">Del</button>`;
        tr.appendChild(tdActions);
        
        habitBody.appendChild(tr);
    });

    // Journal
    renderJournal();
    renderGoals();
    updateChart();
}

function renderJournal() {
    journalArea.innerHTML='';
    for(let i=0;i<7;i++){
        let d=addDays(currentWeekMonday,i); 
        let val=state.journal[formatDate(d)]||'';
        let div = document.createElement('div');
        div.innerHTML = `<div class="small">${d.getDate()}/${d.getMonth()+1}</div>`;
        let ta=document.createElement('textarea'); 
        ta.rows=4; 
        ta.placeholder=`Journal & mood (1-10) for ${d.getDate()}/${d.getMonth()+1}`; 
        ta.value=val;
        ta.addEventListener('input',()=>{
            state.journal[formatDate(d)]=ta.value;
            saveState();
            updateChart();
        });
        div.appendChild(ta);
        journalArea.appendChild(div);
    }
}

function getGoalColor(goalId){let g=state.goals.find(x=>x.id===goalId);return g?g.color:'#fff';}
function renderGoals(){
    goalList.innerHTML='';
    state.goals.forEach(g=>{
        let div=document.createElement('div');
        div.style.marginBottom = '8px';
        div.style.padding = '8px';
        div.style.border = '1px solid rgba(255,255,255,0.1)';
        div.style.borderRadius = '4px';
        div.innerHTML=`<span class="goal-color" style="background-color:${g.color}"></span><strong>${g.name}</strong> (deadline: ${g.deadline}) 
        <button data-edit="${g.id}">Edit</button> <button data-delete="${g.id}">Del</button>`;
        goalList.appendChild(div);
    });
    // Update habit goal select
    hGoal.innerHTML='<option value="">None</option>';
    state.goals.forEach(g=>{hGoal.innerHTML+=`<option value="${g.id}">${g.name}</option>`;});
}

// CRUD
function toggleHabitDay(hid,date,checked){
    let h=state.habits.find(x=>x.id===hid); if(!h) return;
    h.days=h.days||[];
    if(checked&&!h.days.includes(date)) h.days.push(date);
    if(!checked) h.days=h.days.filter(d=>d!==date);
    saveState(); 
    renderWeek();
}

// Events
document.querySelector('#prevWeek').addEventListener('click',()=>{currentWeekMonday=addDays(currentWeekMonday,-7);renderWeek();});
document.querySelector('#nextWeek').addEventListener('click',()=>{currentWeekMonday=addDays(currentWeekMonday,7);renderWeek();});
document.querySelector('#thisWeek').addEventListener('click',()=>{currentWeekMonday=getMonday(new Date());renderWeek();});

// Sync button
document.querySelector('#syncBtn').addEventListener('click',()=>{
    if(syncSettings.token && syncSettings.gistId) {
        syncFromCloud();
    } else {
        document.querySelector('#githubToken').value = syncSettings.token || '';
        document.querySelector('#gistId').value = syncSettings.gistId || '';
        syncModal.style.display='flex';
    }
});

document.querySelector('#saveSync').addEventListener('click',()=>{
    syncSettings.token = document.querySelector('#githubToken').value.trim();
    syncSettings.gistId = document.querySelector('#gistId').value.trim();
    saveSyncSettings();
    syncModal.style.display='none';
    if(syncSettings.token) {
        syncToCloud();
    }
});

document.querySelector('#cancelSync').addEventListener('click',()=>{syncModal.style.display='none';});

// Habit and goal modals
document.querySelector('#addHabitBtn').addEventListener('click',()=>{
    editHabitId=null; hName.value=''; hValue.value=1; hNotes.value=''; hGoal.value=''; habitModal.style.display='flex'; document.querySelector('#habitModalTitle').textContent='Add Habit';
});
document.querySelector('#cancelHabit').addEventListener('click',()=>{habitModal.style.display='none';});
document.querySelector('#saveHabit').addEventListener('click',()=>{
    let name=hName.value.trim(),value=Number(hValue.value)||1,notes=hNotes.value.trim(),goalId=hGoal.value||null;
    if(!name){alert('Enter habit name');return;}
    if(editHabitId){
        let h=state.habits.find(x=>x.id===editHabitId); if(!h) return;
        Object.assign(h,{name,value,notes,goalId});
    } else {state.habits.push({id:id(),name,value,notes,goalId,days:[]});}
    saveState(); habitModal.style.display='none'; renderWeek();
});

document.querySelector('#addGoalBtn').addEventListener('click',()=>{
    editGoalId=null; gName.value=''; gDate.value=''; gColor.value='#60a5fa'; goalModal.style.display='flex'; document.querySelector('#goalModalTitle').textContent='Add Goal';
});
document.querySelector('#cancelGoal').addEventListener('click',()=>{goalModal.style.display='none';});
document.querySelector('#saveGoal').addEventListener('click',()=>{
    let name=gName.value.trim(),deadline=gDate.value,color=gColor.value;
    if(!name){alert('Enter goal name');return;}
    if(editGoalId){
        let g=state.goals.find(x=>x.id===editGoalId); if(!g) return;
        Object.assign(g,{name,deadline,color});
    } else {state.goals.push({id:id(),name,deadline,color});}
    saveState(); goalModal.style.display='none'; renderWeek();
});

document.querySelector('#goalList').addEventListener('click',e=>{
    if(e.target.dataset.edit){let id=e.target.dataset.edit;let g=state.goals.find(x=>x.id===id); if(!g) return;
        editGoalId=id; gName.value=g.name; gDate.value=g.deadline; gColor.value=g.color; goalModal.style.display='flex';
    }
    if(e.target.dataset.delete){if(confirm('Delete goal?')){state.goals=state.goals.filter(x=>x.id!==e.target.dataset.delete);saveState();renderWeek();}}
});

document.querySelector('#habitBody').addEventListener('click',e=>{
    if(e.target.matches('button[data-edit]')){let id=e.target.dataset.edit; let h=state.habits.find(x=>x.id===id); if(!h) return;
        editHabitId=id; hName.value=h.name; hValue.value=h.value; hNotes.value=h.notes; hGoal.value=h.goalId||''; habitModal.style.display='flex';
    }
    if(e.target.matches('button[data-delete]')){if(confirm('Delete habit?')){state.habits=state.habits.filter(x=>x.id!==e.target.dataset.delete);saveState();renderWeek();}}
});

document.querySelector('#resetBtn').addEventListener('click',()=>{if(confirm('Reset all?')){localStorage.removeItem(LS_KEY);state={habits:[],goals:[],journal:{}};renderWeek();}});
document.querySelector('#exportBtn').addEventListener('click',()=>{let blob=new Blob([JSON.stringify(state)],{type:'application/json'});let url=URL.createObjectURL(blob);let a=document.createElement('a');a.href=url;a.download='tracker_export.json';a.click();URL.revokeObjectURL(url);});
document.querySelector('#importBtn').addEventListener('click',()=>{let txt=prompt('Paste JSON'); if(!txt) return; try{state=JSON.parse(txt);saveState();renderWeek();}catch(e){alert('Invalid JSON');}});

// Chart filter
document.querySelector('#chartFilter').addEventListener('change',()=>{updateChart();});

// Chart update
function updateChart(){
    let filter=document.querySelector('#chartFilter').value;
    let labels=[],points=[],mood=[];
    let allDates=[];

    if(filter==='week'){
        // Show current week
        for(let i=0;i<7;i++){
            let d=addDays(currentWeekMonday,i);
            allDates.push(formatDate(d));
        }
    } else if(filter==='all'){
        // Get all unique dates from habits and journal
        let habitDates = new Set();
        state.habits.forEach(h => {
            if(h.days) h.days.forEach(d => habitDates.add(d));
        });
        let journalDates = Object.keys(state.journal);
        journalDates.forEach(d => habitDates.add(d));
        allDates = Array.from(habitDates).sort();
    } else {
        let n=parseInt(filter);
        let today=new Date();
        for(let i=n-1;i>=0;i--){
            allDates.push(formatDate(addDays(today,-i)));
        }
    }

    allDates.forEach(d=>{
        labels.push(d);
        let pts=state.habits.reduce((a,h)=>{return a+((h.days||[]).includes(d)?(h.value||1):0);},0);
        points.push(pts);
        
        let journalText = state.journal[d] || '';
        let moodMatch = journalText.match(/\b([1-9]|10)\b/);
        let m = moodMatch ? parseInt(moodMatch[1]) : 0;
        mood.push(m);
    });

    pointsMoodChart.data.labels=labels; 
    pointsMoodChart.data.datasets[0].data=points; 
    pointsMoodChart.data.datasets[1].data=mood; 
    pointsMoodChart.update();
}

// Auto-load from cloud on startup
if(syncSettings.token && syncSettings.gistId) {
    setTimeout(syncFromCloud, 1000);
}

// Init
renderWeek();
})();
</script>
</body>
</html>